<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debt Deal Screener (EDGAR + OTC)</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0b; color:#fff; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 28px 16px 56px; }
    h1 { font-size: 28px; margin: 0 0 4px; }
    .sub { color:#c9c9c9; margin-bottom: 18px; font-size: 16px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .card { background:#151515; border:1px solid #262626; border-radius:18px; padding: 18px; margin-bottom: 16px; }
    .grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 16px; }
    @media (max-width: 950px){ .grid { grid-template-columns: 1fr; } }
    label { display:block; font-size: 16px; margin: 6px 0; color:#fafafa; }
    input { width:100%; padding: 12px 14px; font-size: 18px; border-radius: 12px; border:1px solid #3a3a3a; background:#1d1d1d; color:#fff; }
    input::placeholder { color:#9a9a9a; }
    .btn { background:#fff; color:#000; font-weight:700; border:none; padding: 12px 16px; border-radius: 12px; cursor:pointer; font-size: 16px; }
    .btn.secondary { background:#262626; color:#fff; border:1px solid #3a3a3a; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .warn { color:#ffc857; font-size:14px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 12px 10px; border-bottom:1px solid #262626; text-align:left; font-size: 15px; }
    th { position: sticky; top: 0; background:#141414; font-size: 13px; text-transform: uppercase; letter-spacing:.03em; color:#cfcfcf; }
    .scroll { max-height: 560px; overflow:auto; border-radius: 12px; }
    .muted { color:#9a9a9a; }
    .kpi { display:inline-block; padding:4px 8px; border:1px solid #2f2f2f; border-radius:10px; margin-left:8px; font-size:12px; color:#c7c7c7; }
    .right { margin-left:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="margin-bottom:8px">
      <h1>Debt Deal Screener</h1>
      <span id="asof" class="kpi">As‑of: —</span>
      <span id="backendStatus" class="kpi">Backend: not set</span>
      <span id="matchCount" class="kpi">Matches: 0</span>
      <div class="right row">
        <input id="backendUrl" placeholder="Paste your backend URL (https://...onrender.com)" style="min-width:420px" />
        <button class="btn secondary" id="saveBackend">Save</button>
      </div>
    </div>
    <div class="sub">Daily Search (EDGAR + OTC) — set your backend URL above once, it will be remembered in this browser.</div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Revenue Minimum (USD)</label>
          <input id="revenue_min" type="text" inputmode="numeric" placeholder="$50,000,000" data-currency>
        </div>
        <div>
          <label>Revenue Maximum (USD)</label>
          <input id="revenue_max" type="text" inputmode="numeric" placeholder="$2,000,000,000" data-currency>
        </div>
        <div>
          <label>Cash Flow from Ops Minimum (USD)</label>
          <input id="cfo_min" type="text" inputmode="numeric" placeholder="$5,000,000" data-currency>
        </div>
        <div>
          <label>Total Debt Maximum (USD)</label>
          <input id="debt_max" type="text" inputmode="numeric" placeholder="$200,000,000" data-currency>
        </div>
        <div>
          <label>Accounts Payable Maximum (USD)</label>
          <input id="ap_max" type="text" inputmode="numeric" placeholder="$10,000,000" data-currency>
        </div>
        <div>
          <label>Trading Volume Minimum ($ ADV)</label>
          <input id="adv_min" type="text" inputmode="numeric" placeholder="$1,000,000" data-currency>
        </div>
        <div>
          <label>Loan Size (USD)</label>
          <input id="loan_size" type="text" inputmode="numeric" value="$3,000,000" data-currency>
        </div>
        <div>
          <label>Max Payback (years)</label>
          <input id="max_payback_years" type="number" value="4">
        </div>
        <div>
          <label>Min Borrowing Base (USD)</label>
          <input id="min_borrow_base" type="text" inputmode="numeric" value="$3,000,000" data-currency>
        </div>
        <div>
          <label>Location (State/Country)</label>
          <input id="location" type="text" placeholder="e.g. NY or USA">
        </div>
        <div>
          <label>Exchanges</label>
          <input id="exchanges" type="text" value="NASDAQ,OTC,NYSE">
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="search" class="btn">Search</button>
        <button id="exportCsv" class="btn secondary">Export CSV</button>
        <span class="warn" id="warn"></span>
      </div>
    </div>

    <div class="card">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Name</th>
              <th>Exchange</th>
              <th>Revenue</th>
              <th>CFO</th>
              <th>Total Debt</th>
              <th>Accounts Payable</th>
              <th>ADV ($)</th>
              <th>Borrowing Base</th>
              <th>Payback (yrs @ Loan)</th>
              <th>Last Fundraising</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // --- Default backend so you don't have to press Save ---
    const DEFAULT_BACKEND_URL = 'https://deal-screener-backend-feev.onrender.com';

    const $ = (id) => document.getElementById(id);
    const LS_KEY = 'ds_backend_url';

    // -------- Currency helpers --------
    const moneyFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
    function toRawNumber(text){
      if (!text) return NaN;
      const cleaned = String(text).replace(/[^0-9.-]/g, '');
      if (cleaned === '' || cleaned === '-' || cleaned === '.') return NaN;
      return Number(cleaned);
    }
    function toCurrency(val){
      if (val == null || val === '' || isNaN(val)) return '';
      return '$' + moneyFormatter.format(Math.round(Number(val)));
    }
    function attachCurrencyBehavior(input){
      // On focus, show raw number to make editing easy
      input.addEventListener('focus', () => {
        const n = toRawNumber(input.value);
        input.value = isNaN(n) ? '' : String(Math.round(n));
      });
      // While typing, keep only digits and optional minus
      input.addEventListener('input', () => {
        const n = toRawNumber(input.value);
        if (isNaN(n)) { input.dataset.empty = '1'; return; }
        input.dataset.empty = '';
      });
      // On blur, format as $#,###
      input.addEventListener('blur', () => {
        const n = toRawNumber(input.value);
        input.value = isNaN(n) ? '' : toCurrency(n);
      });
      // Initialize existing value
      input.value = toCurrency(toRawNumber(input.value));
    }

    function normalizeUrl(input){
      let url = (input || '').trim();
      if (!url) return '';
      if (!/^https?:\/\//i.test(url)) url = 'https://' + url; // auto-prepend https
      url = url.replace(/\/$/, ''); // drop trailing slash
      return url;
    }
    function setBackendStatus(url){
      $('backendStatus').textContent = url ? ('Backend: ' + url) : 'Backend: not set';
    }
    function saveBackend(){
      const url = normalizeUrl($('backendUrl').value);
      if (!url){ $('warn').textContent = 'Please paste a valid https URL.'; return; }
      localStorage.setItem(LS_KEY, url);
      setBackendStatus(url);
      $('warn').textContent = '';
    }

    function n(v){ return v==null ? '—' : moneyFormatter.format(Number(v)); }
    function n$ (v){ return v==null ? '—' : ('$' + moneyFormatter.format(Number(v))); }

    async function search(){
      const base = normalizeUrl(localStorage.getItem(LS_KEY) || $('backendUrl').value || DEFAULT_BACKEND_URL);
      if (!base){ $('warn').textContent = 'Set your backend URL first.'; return; }
      localStorage.setItem(LS_KEY, base); setBackendStatus(base);

      const params = new URLSearchParams();
      const currencyFields = ['revenue_min','revenue_max','cfo_min','debt_max','ap_max','adv_min','loan_size','min_borrow_base'];
      const otherFields = ['max_payback_years','location','exchanges'];

      for (const f of currencyFields){
        const raw = toRawNumber($(f).value);
        if (!isNaN(raw)) params.set(f, String(Math.round(raw)));
      }
      for (const f of otherFields){
        const val = ($(f).value||'').trim();
        if (val) params.set(f, val);
      }

      const btn = $('search'); btn.disabled = true; btn.textContent = 'Searching…';
      try{
        const res = await fetch(`${base}/api/search?` + params.toString());
        const data = await res.json();
        $('asof').textContent = data.date || '—';
        const rows = data.items || [];
        $('matchCount').textContent = 'Matches: ' + rows.length;
        const tbody = $('rows');
        tbody.innerHTML = rows.map(c => (
          `<tr>
            <td>${c.ticker || '—'}</td>
            <td>${c.name || '—'}</td>
            <td>${c.exchange || '—'}</td>
            <td>${n$(c.revenueLTMUSD)}</td>
            <td>${n$(c.cfoLTMUSD)}</td>
            <td>${n$(c.totalDebtUSD)}</td>
            <td>${n$(c.accountsPayableUSD)}</td>
            <td>${n$(c.advUSD)}</td>
            <td>${n$(c.borrowingBaseUSD)}</td>
            <td>${c.paybackYearsAtLoan == null ? '—' : Number(c.paybackYearsAtLoan).toFixed(2)}</td>
            <td>${c.lastFundraisingDate || '—'}</td>
            <td>${c.location || '—'}</td>
          </tr>`)).join('');
        $('warn').textContent = '';
      } catch(e){
        $('warn').textContent = 'Search failed. Is your backend URL correct?';
      } finally { btn.disabled = false; btn.textContent = 'Search'; }
    }

    function exportCsv(){
      const rows = Array.from(document.querySelectorAll('#rows tr'));
      if (!rows.length){ $('warn').textContent = 'Nothing to export yet.'; return; }
      const headers = ['Ticker','Name','Exchange','Revenue','CFO','Total Debt','Accounts Payable','ADV ($)','Borrowing Base','Payback (yrs @ Loan)','Last Fundraising','Location'];
      const data = rows.map(tr => Array.from(tr.children).map(td => '"' + (td.textContent||'').replaceAll('"','""') + '"'));
      const csv = [headers.map(h=>'"'+h+'"').join(','), ...data.map(r=>r.join(','))].join('
');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'deal_screener_results.csv';
      document.body.appendChild(a); a.click(); a.remove();
      $('warn').textContent = '';
    }

    // Wire up
    $('saveBackend').addEventListener('click', saveBackend);
    $('search').addEventListener('click', search);
    $('exportCsv').addEventListener('click', exportCsv);
    $('backendUrl').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ saveBackend(); } });

    // Attach currency formatting
    document.querySelectorAll('input[data-currency]').forEach(attachCurrencyBehavior);

    // On load: prefill backend from localStorage or default, and show status
    (function init(){
      const saved = normalizeUrl(localStorage.getItem(LS_KEY) || DEFAULT_BACKEND_URL);
      $('backendUrl').value = saved;
      if (saved) { localStorage.setItem(LS_KEY, saved); setBackendStatus(saved); }
    })();
  </script>
</body>
</html>
